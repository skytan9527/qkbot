# 企业微信应用使用说明

## 概述

`quark_app.py` 是基于企业微信应用的服务器程序，集成了测试脚本的所有功能。与群机器人版本（`quark_bot.py`）不同，这个版本使用企业微信应用（API模式），可以接收用户消息并自动处理。

## 功能特性

- ✅ 接收用户消息（文本消息）
- ✅ 设置Cookie（通过消息：`cookie: <cookie内容>`）
- ✅ 验证Cookie（通过消息：`verify`）
- ✅ 转存分享链接（发送夸克网盘链接）
- ✅ 批量转存（发送包含多个链接的文本）
- ✅ 搜索文件（发送关键词，自动搜索配置的文件夹）
- ✅ 生成分享链接（从搜索结果中选择序号）

## 配置步骤

### 1. 在Web配置界面配置企业微信应用

1. 打开Web配置界面（http://localhost:5000）
2. 在"企业微信配置"区域，填写：
   - 企业ID (CorpId)
   - 应用ID (AgentId)
   - 应用密钥 (Secret)
   - Token（可选，用于URL验证）
   - EncodingAESKey（可选，用于消息加密，如果不配置则使用明文模式）
3. 配置文件夹：
   - 转存目标文件夹（文件转存的位置）
   - 搜索文件夹（搜索功能查找文件的位置）
4. 点击"保存所有配置"

### 2. 配置企业微信应用的回调URL

1. 登录企业微信管理后台
2. 进入"应用管理"，选择您的应用
3. 在"API接收"设置中，填写：
   - **URL**：`http://your-server:8888/wechat/callback`
     - 如果是本地测试，可以使用内网穿透工具（如ngrok）
     - 生产环境需要使用公网可访问的域名
   - **Token**：填写与配置文件中相同的Token（如果配置了）
   - **EncodingAESKey**：填写与配置文件中相同的EncodingAESKey（如果配置了）
4. 点击"保存"
5. 企业微信会验证URL，确保服务器已启动

### 3. 启动服务器

```bash
python quark_app.py
```

服务器启动后会显示：
```
企业微信应用服务器启动成功
监听地址: http://0.0.0.0:8888
回调URL: http://0.0.0.0:8888/wechat/callback
```

## 使用方法

### 在企业微信中发送消息

#### 1. 设置Cookie

发送消息：
```
cookie: <您的Cookie内容>
```

系统会自动验证Cookie并保存。

#### 2. 验证Cookie

发送消息：
```
verify
```
或
```
验证
```
或
```
检查cookie
```

#### 3. 转存单个链接

直接发送夸克网盘分享链接：
```
https://pan.quark.cn/s/xxxxx?pwd=1234
```

系统会自动：
1. 转存文件到配置的转存文件夹
2. 生成新的分享链接
3. 发送结果消息

#### 4. 批量转存

发送包含多个链接的文本：
```
文件1: https://pan.quark.cn/s/xxxxx
文件2: https://pan.quark.cn/s/yyyyy
文件3: https://pan.quark.cn/s/zzzzz
```

系统会自动：
1. 提取所有链接
2. 逐个转存
3. 生成新的分享链接
4. 保留原文结构，替换链接
5. 发送结果消息

#### 5. 搜索文件

发送关键词（不包含链接的文本）：
```
测试文件
```

系统会：
1. 在配置的搜索文件夹中搜索
2. 返回匹配的文件和文件夹列表
3. 提示输入序号生成分享链接

#### 6. 从搜索结果生成分享链接

在搜索完成后，发送序号（数字）：
```
1
```

系统会为选中的文件/文件夹生成分享链接。

## 消息处理逻辑

1. **以 `cookie:` 开头** → 设置Cookie
2. **`verify`、`验证`、`检查cookie`** → 验证Cookie
3. **纯数字** → 从搜索结果中选择文件生成分享链接
4. **包含夸克网盘链接** → 转存链接（单个或多个）
5. **其他文本** → 作为搜索关键词

## 配置文件

配置保存在 `config/bot_config.json`：

```json
{
  "mode": "app",
  "corp_id": "wwxxxxxxxxxxxxxxxx",
  "agent_id": "1000001",
  "secret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "token": "your-token-123",
  "encoding_aes_key": "43位字符的加密密钥",
  "host": "0.0.0.0",
  "port": 8888,
  "default_folder_id": "0",
  "default_folder_name": "根目录",
  "search_folder_id": "0",
  "search_folder_name": "根目录"
}
```

## 与群机器人版本的区别

| 特性 | 群机器人版本 (quark_bot.py) | 应用版本 (quark_app.py) |
|------|---------------------------|------------------------|
| 连接方式 | Webhook URL | API（CorpId + AgentId + Secret） |
| 接收消息 | 不支持 | 支持 |
| 发送消息 | 支持 | 支持 |
| 配置复杂度 | 简单（只需Webhook URL） | 较复杂（需要多个参数） |
| 适用场景 | 只需要发送通知 | 需要双向交互 |

## 注意事项

1. **消息加密**：
   - 如果配置了 `encoding_aes_key`，消息会被加密
   - 当前版本使用简化的消息处理（支持明文模式）
   - 如需完整支持加密消息，需要安装 `pycryptodome` 库并实现完整的加解密逻辑

2. **URL验证**：
   - 企业微信在配置回调URL时会进行验证
   - 确保服务器已启动并可访问
   - 如果配置了Token，需要在代码中实现验证逻辑

3. **网络要求**：
   - 回调URL必须可从公网访问
   - 本地开发可使用内网穿透工具（如ngrok）
   - 生产环境建议使用HTTPS

4. **Cookie管理**：
   - Cookie保存在 `config/cookies.txt`
   - 建议定期检查Cookie是否有效

## 故障排除

### 1. 消息接收失败

- 检查服务器是否正常运行
- 检查回调URL是否正确配置
- 检查防火墙设置
- 查看服务器日志

### 2. 发送消息失败

- 检查CorpId、AgentId、Secret是否正确
- 检查应用是否已启用
- 检查应用是否有发送消息权限
- 检查用户是否在应用可见范围内

### 3. Cookie相关错误

- 检查Cookie是否有效
- 重新设置Cookie
- 检查Cookie文件权限

## 参考文档

- [企业微信开发文档](https://developer.work.weixin.qq.com/document)
- [接收消息与事件](https://developer.work.weixin.qq.com/document/path/90970)
- [发送应用消息](https://developer.work.weixin.qq.com/document/path/90236)


