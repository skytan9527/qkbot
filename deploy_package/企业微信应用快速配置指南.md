# 企业微信应用快速配置指南

## 第一步：准备配置信息

### 1. 获取企业微信应用信息

1. **登录企业微信管理后台**
   - 访问：https://work.weixin.qq.com/
   - 使用管理员账号登录

2. **获取企业ID (CorpId)**
   - 点击"我的企业"
   - 在"企业信息"中找到"企业ID"
   - 复制企业ID（格式：`wwxxxxxxxxxxxxxxxx`）

3. **创建应用并获取应用ID和密钥**
   - 进入"应用管理"
   - 点击"自建" → "创建应用"
   - 填写应用名称（如：夸克网盘助手）
   - 上传应用图标（可选）
   - 创建成功后，在应用详情页面找到：
     - **AgentId**（应用ID，数字）
     - **Secret**（应用密钥，长字符串）

4. **配置API接收（可选，用于接收消息）**
   - 在应用详情页面，找到"API接收"设置
   - 如果只需要发送消息，可以跳过这一步
   - 如果需要接收消息，填写：
     - **URL**：稍后配置（如：`http://your-server:8888/wechat/callback`）
     - **Token**：自定义令牌（如：`my-token-123`）
     - **EncodingAESKey**：点击"随机获取"（43位字符）
   - 点击"保存"
   - **重要**：复制生成的 **EncodingAESKey**

## 第二步：在Web界面配置

### 1. 启动Web配置界面

```bash
python web_config.py
```

### 2. 访问配置界面

打开浏览器，访问：http://localhost:5000

### 3. 配置Cookie（必须先配置）

1. 在"Cookie配置"区域
2. 获取Cookie：
   - 打开浏览器，访问 https://pan.quark.cn/
   - 登录夸克网盘
   - 按 `F12` 打开开发者工具
   - 切换到 `Network` 标签
   - 刷新页面
   - 找到任意请求，查看 `Request Headers` 中的 `Cookie`
   - 复制完整的Cookie值
3. 在配置界面粘贴Cookie
4. 点击"设置Cookie"
5. 等待验证通过

### 4. 配置文件夹

1. 在"文件夹配置"区域
2. 点击"刷新文件夹列表"（需要先设置Cookie）
3. 选择"转存目标文件夹"（文件转存的位置）
4. 选择"搜索文件夹"（搜索功能查找文件的位置）

### 5. 配置企业微信应用

1. 在"企业微信配置"区域
2. 填写以下信息：
   - **企业ID (CorpId)**：从第一步获取
   - **应用ID (AgentId)**：从第一步获取
   - **应用密钥 (Secret)**：从第一步获取
   - **Token**（可选）：如果配置了API接收，填写第一步获取的Token
   - **消息加密密钥 (EncodingAESKey)**（可选）：如果配置了API接收，填写第一步获取的EncodingAESKey
3. 点击"测试配置"验证配置是否正确
4. 如果测试成功，点击"保存所有配置"

## 第三步：配置企业微信回调URL（如果需要接收消息）

### 方式一：本地测试（使用内网穿透）

1. **安装内网穿透工具**（如ngrok）
   ```bash
   # macOS
   brew install ngrok
   
   # 或下载：https://ngrok.com/download
   ```

2. **启动内网穿透**
   ```bash
   ngrok http 8888
   ```

3. **获取公网URL**
   - ngrok会显示一个公网URL，如：`https://xxxxx.ngrok.io`
   - 记下这个URL

4. **在企业微信管理后台配置回调URL**
   - 进入应用详情页面
   - 在"API接收"设置中，填写：
     - **URL**：`https://xxxxx.ngrok.io/wechat/callback`
     - **Token**：与Web配置界面中填写的一致
     - **EncodingAESKey**：与Web配置界面中填写的一致
   - 点击"保存"
   - 企业微信会验证URL，确保服务器已启动

### 方式二：生产环境（使用公网服务器）

1. **确保服务器可以从公网访问**
2. **配置域名和HTTPS**（推荐）
3. **在企业微信管理后台配置回调URL**
   - **URL**：`https://your-domain.com/wechat/callback`
   - **Token**：与Web配置界面中填写的一致
   - **EncodingAESKey**：与Web配置界面中填写的一致

## 第四步：启动服务器

### 1. 启动企业微信应用服务器

```bash
python quark_app.py
```

### 2. 确认服务器启动成功

看到以下输出表示启动成功：
```
企业微信应用服务器启动成功
监听地址: http://0.0.0.0:8888
回调URL: http://0.0.0.0:8888/wechat/callback
```

## 第五步：测试

### 1. 在企业微信中测试

1. **打开企业微信**
2. **找到您创建的应用**
3. **发送测试消息**：

   **设置Cookie：**
   ```
   cookie: <您的Cookie内容>
   ```

   **验证Cookie：**
   ```
   verify
   ```

   **转存链接：**
   ```
   https://pan.quark.cn/s/xxxxx
   ```

   **搜索文件：**
   ```
   测试文件
   ```

### 2. 查看服务器日志

服务器会输出详细的日志信息，包括：
- 收到的消息
- 处理结果
- 错误信息（如果有）

## 常见问题

### Q1: 配置文件在哪里？

A: 配置文件保存在 `config/bot_config.json`

### Q2: 如何查看配置是否正确？

A: 运行测试脚本：
```bash
python test_app.py
```

### Q3: 只发送消息，不接收消息，需要配置回调URL吗？

A: 不需要。如果只需要发送消息，可以：
- 不配置Token和EncodingAESKey
- 不配置回调URL
- 直接使用 `quark_app.py` 发送消息（需要通过代码调用）

但如果是通过企业微信接收用户消息，必须配置回调URL。

### Q4: 本地测试如何接收消息？

A: 使用内网穿透工具（如ngrok），将本地端口映射到公网。

### Q5: 消息发送失败怎么办？

A: 检查：
1. CorpId、AgentId、Secret是否正确
2. 应用是否已启用
3. 应用是否有发送消息权限
4. 用户是否在应用可见范围内
5. 运行 `python test_app.py` 查看详细错误信息

### Q6: 接收消息失败怎么办？

A: 检查：
1. 服务器是否正常运行
2. 回调URL是否正确配置
3. Token和EncodingAESKey是否与配置一致
4. 服务器是否可以从公网访问
5. 查看服务器日志

## 下一步

配置完成后，可以：
1. 在企业微信中发送消息测试
2. 查看服务器日志确认功能正常
3. 根据需要调整配置

## 参考文档

- [企业微信应用配置说明.md](./企业微信应用配置说明.md) - 详细的配置说明
- [企业微信应用使用说明.md](./企业微信应用使用说明.md) - 使用说明
- [企业微信开发文档](https://developer.work.weixin.qq.com/document)


